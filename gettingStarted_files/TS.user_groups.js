(function(){"use strict";TS.registerModule("user_groups",{updated_sig:new signals.Signal,onStart:function(){},getUserGroupsByHandle:function(handle){handle=TS.utility.getLowerCaseValue(handle);var user_groups=TS.model.user_groups;var user_group=_handle_map[handle];if(user_group)return user_group;if(!user_groups)return;for(var i=0;i<user_groups.length;i++){user_group=user_groups[i];if(user_group.handle==handle||"@"+user_group.handle==handle){TS.warn(handle+" not in _handle_map?");_handle_map["@"+handle]=user_group;_handle_map[handle]=user_group;return user_group}}return null},getUserGroupsById:function(id){if(TS.model.user&&TS.model.user.is_restricted)return false;var user_groups=TS.model.user_groups;var user_group=_id_map[id];if(user_group)return user_group;if(!user_groups)return;for(var i=0;i<user_groups.length;i++){user_group=user_groups[i];if(user_group.id==id){TS.warn(id+" not in _id_map?");_id_map[id]=user_group;return user_group}}return null},getUserGroupMembers:function(id,handler){TS.api.call("subteams.users.list",{subteam:id,include_disabled:1},function(ok,data){if(ok&&data){var user_group=TS.user_groups.getUserGroupsById(id);if(user_group){user_group.users=data.users;user_group.user_count=data.users.length;TS.user_groups.upsertUserGroupAndSignal(user_group);user_group=TS.user_groups.getUserGroupsById(id);if(handler){handler(user_group)}}}})},updateMembersOfUserGroup:function(data,handler){TS.api.call("subteams.users.update",data,handler)},createUserGroup:function(data,handler){TS.api.call("subteams.create",data,handler)},updateUserGroup:function(data,handler){TS.api.call("subteams.update",data,handler)},enableUserGroup:function(user_group_id,handler){TS.api.call("subteams.enable",{subteam:user_group_id},handler)},disableUserGroup:function(user_group_id,handler){TS.api.call("subteams.disable",{subteam:user_group_id},handler)},deleteUserGroup:function(user_group_id,handler){TS.api.call("subteams.delete",{subteam:user_group_id,include_disabled:1},handler)},getMembersInCorG:function(user_group_id,id,callback){var ug=TS.user_groups.getUserGroupsById(user_group_id);var channel=TS.channels.getChannelById(id)||TS.groups.getGroupById(id);var result=[];var filter_members=function(){var group=TS.user_groups.getUserGroupsById(user_group_id);var members=group.users.filter(function(member_id){return channel.members.indexOf(member_id)!==-1});return members};var do_work=function(){result=filter_members();return callback(result)};if(!ug||!channel){return callback(result)}if(ug.users===undefined){if(!_pending_group_requests[user_group_id]){_pending_group_requests[user_group_id]=true;TS.user_groups.getUserGroupMembers(user_group_id,function(updated_group){if(updated_group&&updated_group.users){_pending_group_requests[user_group_id]=false;ug=updated_group;return do_work()}})}else{return callback(result)}}else{return do_work()}},upsertUserGroup:function(user_group){if(TS.model.user&&TS.model.user.is_restricted)return false;var existing_user_group=TS.user_groups.getUserGroupsById(user_group.id);user_group._name_lc=user_group.name.toLowerCase();if(existing_user_group){TS.log(4,'updating existing user group "'+user_group.id+'"');var user_user_group=TS.model.your_user_group_regex[user_group.id];if(user_user_group)TS.user_groups.removeSelfUserGroup(existing_user_group.id);for(var k in user_group){if(existing_user_group[k]!=user_group[k]){existing_user_group[k]=user_group[k]}}if(!user_group.date_delete&&user_group.users&&user_group.users.indexOf(TS.model.user.id)!==-1){if(!TS.user_groups.getUserGroupsById(user_group.id)){TS.model.user_groups.push(user_group)}TS.user_groups.upsertSelfUserGroup(existing_user_group.id);_assignMapsForGroup(user_group)}}else if(!user_group.date_delete){TS.log(4,'Adding user group "'+user_group.id+'"');if(!TS.user_groups.getUserGroupsById(user_group.id)){TS.model.user_groups.push(user_group)}_assignMapsForGroup(user_group)}TS.model.user_groups.sort(function(a,b){return a._name_lc.localeCompare(b._name_lc)});TS.user_groups.updated_sig.dispatch()},upsertUserGroupAndSignal:function(user_group){TS.user_groups.upsertUserGroup(user_group);TS.user_groups.updated_sig.dispatch(user_group.id)},removeUserGroup:function(user_group){var existing_user_group=TS.user_groups.getUserGroupsById(user_group.id);if(existing_user_group){TS.user_groups.removeSelfUserGroup(existing_user_group.id);_deleteMapsForGroup(existing_user_group);existing_user_group.date_delete=-1}},removeUserGroupAndSignal:function(user_group){TS.user_groups.removeUserGroup(user_group);TS.user_groups.updated_sig.dispatch(user_group.id)},upsertSelfUserGroup:function(user_group_id){var existing_user_group_regex=TS.model.your_user_group_regex[user_group_id];if(existing_user_group_regex)TS.user_groups.removeSelfUserGroup(user_group_id);var ug=TS.user_groups.getUserGroupsById(user_group_id);if(ug&&!ug.date_delete){var user_group_regex=new RegExp("<!subteam\\^("+ug.id+(ug.handle?"|"+ug.handle:"")+")\\b");TS.model.your_user_group_regex[ug.id]=user_group_regex;if(ug.handle){TS.model.highlight_words.push("@"+ug.handle);TS.model.highlight_words_regex=null}}},removeSelfUserGroup:function(user_group_id){TS.model.your_user_group_regex[user_group_id]=null;delete TS.model.your_user_group_regex[user_group_id];var ug=TS.user_groups.getUserGroupsById(user_group_id);if(ug){if(ug.handle)TS.utility.removeFromArray(TS.model.highlight_words,"@"+ug.handle);_deleteMapsForGroup(ug);TS.model.highlight_words_regex=null;TS.user_groups.updated_sig.dispatch(ug.id)}},test:function(){return{clearUseGroupMaps:_clearUseGroupMaps}}});var _handle_map={};var _id_map={};var _clearUseGroupMaps=function(){_handle_map={};_id_map={}};var _assignMapsForGroup=function(user_group){if(!user_group)return;if(user_group.handle){_handle_map[user_group.handle]=user_group;_handle_map["@"+user_group.handle]=user_group}_id_map[user_group.id]=user_group};var _deleteMapsForGroup=function(user_group){if(!user_group)return;if(user_group.handle){delete _handle_map[user_group.handle];delete _handle_map["@"+user_group.handle]}delete _id_map[user_group.id]};var _pending_group_requests={}})();

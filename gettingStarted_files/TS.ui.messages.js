(function(){"use strict";TS.registerModule("ui.messages",{onStart:function(){TS.pins.pinned_status_changed_sig.add(function(){_updateMsgActions()});var $body=$("body");$body.on("click.msg_action","ts-message",function(e){if(TS.client&&TS.client.ui.checkForEditing(e))return;if(_isAnyTextSelected())return;_msgActionHandler(e)});if(TS.replies){var timer_delay=150;$body.on("mousedown.maybe_select_message",'ts-message[data-selectable="true"]',function(e){if(TS.client&&TS.client.ui.checkForEditing(e))return;if(TS.model.menu_is_showing||TS.emoji_menu.is_showing)return;if(_isAnyTextSelected())return;var click_timer;$body.on("mouseup.select_message",'ts-message[data-selectable="true"]',function(e2){if(_isAnyTextSelected())return;click_timer=setTimeout(function(){if(_isAnyTextSelected())return;if(_isValidClick(e,e2))_msgSelectHandler(e);$body.off("mouseup.select_message mousedown.second_click dblclick.select_text",'ts-message[data-selectable="true"]')},timer_delay)}).on("dblclick.select_text",'ts-message[data-selectable="true"]',function(e){clearTimeout(click_timer);$body.off("dblclick.select_text",'ts-message[data-selectable="true"]')})}).on("keydown.esc_deselect_messages",function(e){if(e.which!=TS.utility.keymap.esc)return;if(TS.menu.isRedundantClick(e))return;if(TS.client&&TS.client.ui.checkForEditing(e))return;if(TS.model.menu_is_showing)return;if(TS.emoji_menu.is_showing)return;if(TS.model.dialog_is_showing)return;TS.ui.messages.deselectAll()})}},selectMsgEl:function($el,no_scroll){var model_ob=TS.shared.getActiveModelOb();var msg_ts=$el.data("ts");var msg=TS.utility.msgs.getMsg(msg_ts,model_ob.msgs);var replies_enabled=TS.replies&&TS.replies.isEnabledForModelOb(model_ob)&&TS.client;if(!replies_enabled)return;var $prev_selected_msg=$(".msgs_holder").find("ts-message.selected");if(!msg)msg=TS.utility.msgs.getMsg(msg_ts,model_ob._archive_msgs);if(!msg){TS.error("WTF no message to select?");return}var was_already_selected=$el.hasClass("selected");if(!was_already_selected&&$prev_selected_msg.length){var no_scroll=true;TS.ui.messages.deselectMsgEl($prev_selected_msg,no_scroll)}if(replies_enabled&&!was_already_selected){TS.ui.replies.maybeRenderReplies(model_ob,msg,$el)}_scrollMsgBasedOnSelection($el,no_scroll);_updateMsgActions(msg_ts);$el.scrollintoview()},deselectMsgEl:function($el,no_scroll){if(no_scroll){$el.removeClass("selected")}else{_scrollMsgBasedOnSelection($el)}$el.find(".message_actions, .message_reply").empty();if(TS.ui.replies)TS.ui.replies.closeConversation($el)},getSelectedMessage:function(){var $selected_msg=$(".msgs_holder ts-message.selected");if(!$selected_msg.length&&TS.replies&&TS.replies.isEnabled()){return $("ts-conversation ts-message.selected")}return $selected_msg},deselectAll:function(){var $selected_msg=TS.ui.messages.getSelectedMessage();if($selected_msg.length)TS.ui.messages.deselectMsgEl($selected_msg)},updateMessageActions:function(model_ob,$msg_el,msg){var actions=TS.utility.msgs.getMsgActions(msg);var allow_mark_unread=TS.client&&TS.utility.msgs.getMarkMsgForUnreadPoint(msg.ts,model_ob.msgs)&&!TS.model.archive_view_is_showing;actions.mark_unread=!!allow_mark_unread;var actions_html=TS.templates.message_actions({actions:actions,msg:msg,model_ob:model_ob,abs_permalink:TS.utility.msgs.constructAbsoluteMsgPermalink(model_ob,msg.ts),ts_tip_delay_class:"ts_tip_delay_600"});$msg_el.find(".message_actions").html(actions_html);if(TS.ui.replies&&$msg_el.is(".selected"))TS.ui.replies.updateMessageActions(model_ob,$msg_el,msg)}});var _isAnyTextSelected=function(){return window.getSelection().toString().trim()!=""};var _isValidClick=function(mousedown_event,mouseup_event){var p1={x:mousedown_event.pageX,y:mousedown_event.pageY};var p2={x:mouseup_event.pageX,y:mouseup_event.pageY};var click_distance_threshold_px=4;var delta=Math.sqrt(Math.pow(p2.x-p1.x,2)+Math.pow(p2.y-p1.y,2));return delta<click_distance_threshold_px};var _msgActionHandler=function(e){var $el=$(e.target);var $action_el=$el.closest("[data-action]");if($action_el.length){var $msg_el=$el.closest("ts-message");var model_ob=TS.shared.getActiveModelOb();var msg_ts=$msg_el.data("ts");var msg=TS.utility.msgs.getMsg(msg_ts,model_ob.msgs);var action=$action_el.data("action");if(!msg)msg=TS.utility.msgs.getMsg(msg_ts,model_ob._archive_msgs);if(!msg&&TS.replies){msg=TS.replies.getMessage(model_ob.id,msg_ts)}if(!msg){TS.error("WTF no message to click?");return}var rxn_key=TS.rxns.getRxnKeyByMsgType(msg);switch(action){case"actions_menu":if(TS.model.archive_view_is_showing){TS.menu.startWithMessageActions(e,$msg_el.data("ts"),model_ob._archive_msgs)}else{TS.menu.startWithMessageActions(e,$msg_el.data("ts"),model_ob.msgs)}break;case"reaction":TS.emoji_menu.startEmoForRxn(e,rxn_key);break;case"pin":TS.pins.startPinMessage(msg_ts,model_ob);break;case"unpin":TS.pins.unPinMessage(msg_ts,model_ob);break;case"edit":TS.msg_edit.startEdit(msg_ts,model_ob);break;case"delete":TS.msg_edit.startDelete(msg_ts,model_ob);break;case"mark_unread":TS.client.msg_pane.setUnreadPoint(msg_ts);break;case"copy_link":TS.tips.updateFloater({title:"Copied!",classes_to_add:["success"]});TS.clipboard.writeText($action_el.data("permalink"));break;default:TS.error("WTF no action?");break}}};var _msgSelectHandler=function(e){var $el=$(e.target);var $msg_el=$el.closest("ts-message");var model_ob=TS.shared.getActiveModelOb();var msg_ts=$msg_el.data("ts");var msg=TS.utility.msgs.getMsg(msg_ts,model_ob.msgs);if(!msg)msg=TS.utility.msgs.getMsg(msg_ts,model_ob._archive_msgs);if(!msg&&TS.replies){msg=TS.replies.getMessage(model_ob.id,msg_ts)}if(!msg){TS.error("WTF no message to click?");return}var selectors_to_ignore=["a",".star",".emoji_rxn",".delete_attachment_link",".inline_message_input_container",".msg_inline_img_expander",".msg_inline_img_collapser",".msg_inline_email_expander",".msg_inline_email_collapser",".msg_inline_video_expander",".msg_inline_video_collapser",".msg_inline_other_expander",".msg_inline_other_collapser",".msg_inline_audio_expander",".msg_inline_audio_collapser",".msg_inline_attachment_expander",".msg_inline_attachment_collapser",".msg_inline_file_preview_expander",".msg_inline_file_preview_collapser",".msg_inline_room_preview_expander",".msg_inline_room_preview_collapser",".msg_inline_holder",".preview_show_btn",".inline_collapsed"];if($el.closest(selectors_to_ignore.join(",")).length==1)return;var replies_enabled=TS.replies&&TS.replies.isEnabledForModelOb(model_ob);var is_relative_in_conversation=replies_enabled&&$msg_el.is("ts-relatives ts-message");if(is_relative_in_conversation){if(TS.ui.replies)TS.ui.replies.refocusConversation(model_ob,msg,$msg_el)}else if($msg_el.hasClass("selected")){TS.ui.messages.deselectMsgEl($msg_el)}else{var $existing_sel=TS.ui.messages.getSelectedMessage();if($existing_sel.length){TS.ui.messages.deselectMsgEl($existing_sel)}if(replies_enabled&&!e.altKey){TS.ui.messages.selectMsgEl($msg_el);return}if(replies_enabled&&(e.metaKey||e.ctrlKey)){TS.ui.messages.selectMsgEl($msg_el);return}}};var _scrollMsgBasedOnSelection=function($msg_el,no_scroll){var $msg_body_el=$msg_el.find(".message_body");if(!$msg_body_el.length)$msg_body_el=$msg_el.find(".comment");if(no_scroll||!$msg_body_el.length){$msg_el.toggleClass("selected");return}TS.ui.utility.preventElementFromScrolling($msg_body_el,function(){$msg_el.toggleClass("selected")})};var _updateMsgActions=function(msg_ts){var $msg_els;var model_ob=TS.shared.getActiveModelOb();var msg;if(msg_ts){$msg_els=$("#"+TS.templates.makeMsgDomId(msg_ts))}else{$msg_els=$(".msgs_holder").find("ts-message.selected")}if($msg_els.length===0)return;$msg_els.each(function(){var $msg_el=$(this);msg=TS.utility.msgs.getMsg($msg_el.data("ts"),model_ob.msgs);if(!msg)msg=TS.utility.msgs.getMsg(msg_ts,model_ob._archive_msgs);if(!msg){TS.error("WTF no message to update?");return}TS.ui.messages.updateMessageActions(model_ob,$msg_el,msg)})}})();

(function(){"use strict";TS.registerModule("ui.admin_user_groups",{user_groups_fetched:new signals.Signal,onStart:function(){$("body").on("click",'[data-action="admin_user_groups_modal"]',function(){_start()});$("body").on("click",'[data-action="admin_user_groups_modal_new"]',function(){TS.ui.admin_user_groups.add()})},start:function(){_start()},add:function(){_start();_close_when_done=true;_switchSettingsFormView()},editInfo:function(user_group){_start();_close_when_done=true;_switchSettingsFormView(user_group)},editMembers:function(user_group){_start();_close_when_done=true;_switchMembersFormView(user_group,false)},disable:function(user_group){_start();_close_when_done=true;_switchToggleView(user_group,"disable_user_group")},enable:function(user_group){_start();_close_when_done=true;_switchToggleView(user_group,"enable_user_group")},remove:function(user_group){_start();_close_when_done=true;_switchToggleView(user_group,"delete_user_group")}});var _$div;var _$all_user_groups;var _$user_groups_form_div;var _$user_groups_toggle_div;var _refresh_list=true;var _user_groups=[];var _temp_user_group;var _close_when_done=false;var _start=function(){var body_template_html=TS.templates.user_group_modal({show_info_pane:!TS.model.prefs.hide_user_group_info_pane,show_user_groups_add:TS.members.canUserCreateAndDeleteUserGroups()});var settings={body_template_html:body_template_html,on_show:_onShow,on_cancel:_onCancel};TS.ui.fs_modal.start(settings)};var _onShow=function(){_$div=$("#user_groups_container");_$all_user_groups=$("#all_user_groups");_$user_groups_form_div=$("#user_groups_form_div");_$user_groups_toggle_div=$("#user_groups_toggle_div");_switchListView();_$div.find('[data-action="open_form"]').on("click",function(e){e.preventDefault();var id=$(this).closest(".user_group_item").data("user-group-id");var user_group=_getUserGroupFromId(id);_switchSettingsFormView(user_group)})};var _onCancel=function(){_refresh_list=true;if(_temp_user_group){TS.user_groups.deleteUserGroup(_temp_user_group.id)}_$div=null;_$all_user_groups=null;_$user_groups_form_div=null;_$user_groups_toggle_div=null;_close_when_done=false;_$monkey_scroll=null;_$icon_close=null;$(window).off("resize",_onResizeList)};var _onReset=function(e){if(e)e.preventDefault();if(!_close_when_done){_switchListView()}else{TS.ui.fs_modal.close();_$monkey_scroll=null}};var _onUpdateComplete=function(){if(!_close_when_done){_refresh_list=true;_switchListView()}else{TS.ui.fs_modal.close();_$monkey_scroll=null}};var _bindBackButton=function(){if(!_close_when_done){TS.ui.fs_modal.bindBackButton(_switchListView);TS.ui.fs_modal.showBackButton()}};var _findAutoUserGroup=function(auto_type){if(!_user_groups||!auto_type)return false;for(var i=0,j=_user_groups.length;i<j;i++){if(_user_groups[i].auto_type===auto_type){return _user_groups[i]}}return false};var _alertIfNotOk=function(ok,data){if(!ok){var group_name=$("#user_group_name_input").val()||"";var group_handle=$("#user_group_handle_input").val()||"";data.group_name=group_name;data.group_handle=group_handle;if(TS.boot_data.feature_subteams_auto_suggest&&data.error&&(data.error==="forbidden_handle"||data.error==="forbidden_name")){var combined_input=group_name+group_handle;if(combined_input){var auto_owners=_findAutoUserGroup("owner");var auto_admins=_findAutoUserGroup("admin");var looks_like_admin_group=!!combined_input.match(/admins/i);var looks_like_owner_group=!!combined_input.match(/owners/i);data.suggest_auto_group=true;data.can_create_auto_owners=looks_like_owner_group&&TS.model.user.is_admin&&!auto_owners;data.can_enable_auto_owners=looks_like_owner_group&&auto_owners&&auto_owners.date_delete;data.can_create_auto_admins=looks_like_admin_group&&TS.model.user.is_admin&&!auto_admins;data.can_enable_auto_admins=looks_like_admin_group&&auto_admins&&auto_admins.date_delete}}$("#user_group_alerts").html(TS.templates.user_group_alerts(data));return true}return false};var _onResizeList=function(){var $groups_header=$("#user_groups_header");var $list=$("#user_groups_list_div");var groups_header_padding=parseInt($groups_header.css("padding-top"),10);var header_height=$groups_header[0].offsetHeight;var window_height=$(window).height();var min_list_height=250;var height=Math.max(min_list_height,window_height-header_height-groups_header_padding);$list.css("height",height)};var _switchListView=function(highlight_id){if(_refresh_list){var $user_group_list=$("#user_groups_list_div");$user_group_list.html(Handlebars.helpers.loadingHTML());TS.api.call("subteams.list",{include_disabled:1,include_users:1},function(ok,data){if(_alertIfNotOk(ok,data))return;_user_groups=data.subteams;for(var i=0,j=_user_groups.length;i<j;i++){_user_groups[i]._name_lc=_user_groups[i].name.toLowerCase()}_user_groups.sort(function(a,b){return a._name_lc.localeCompare(b._name_lc)});TS.ui.admin_user_groups.user_groups_fetched.dispatch(_user_groups);_refreshList();_bindListUI();if(highlight_id){$('#fs_modal [data-user-group-id="'+highlight_id+'"]').addClass("highlight_yellow");$("#fs_modal").animate({scrollTop:$(".highlight_yellow").offset().top},500)}});_refresh_list=false}_$all_user_groups.removeClass("hidden");_$user_groups_form_div.addClass("hidden");_$user_groups_toggle_div.addClass("hidden");TS.ui.fs_modal.hideBackButton()};var _bindListUI=function(){$(window).on("resize",_onResizeList);_onResizeList();$("#user_groups_list_div").monkeyScroll();_$monkey_scroll=$("#user_groups_list_div").data("monkeyScroll");$("#user_group_modal_search").on("keydown keyup change",_updateSearch);_$icon_close=$("#user_groups_header .user_groups_search .icon_close");_$icon_close.off("click").on("click",_clearSearch);_$all_user_groups.off("click");_$all_user_groups.on("click",'[data-action="open_form"]',function(e){e.preventDefault();var $target=$(e.target);var id=$target.closest(".user_group_item").data("user-group-id");var user_group=_getUserGroupFromId(id);_switchSettingsFormView(user_group)});_$all_user_groups.on("click",'[data-action="edit_members"]',function(e){e.preventDefault();var $target=$(e.target);var id=$target.closest(".user_group_item").data("user-group-id");var user_group=_getUserGroupFromId(id);_switchMembersFormView(user_group)});_$all_user_groups.on("click",'[data-action="hide_info_pane"]',function(e){e.preventDefault();TS.prefs.setPrefByAPI({hide_user_group_info_pane:true},function(ok,data){if(_alertIfNotOk(ok,data))return;_$div.find(".info_panel").addClass("hidden")})});_$all_user_groups.on("click",".user_group_toggle_btn",function(e){e.preventDefault();var $target=$(e.target).closest("button, a");var id=$target.closest(".user_group_item").data("user-group-id");var action=$target.data("action");var user_group=_getUserGroupFromId(id);_switchToggleView(user_group,action)});_$all_user_groups.on("click",".clear_members_filter",_clearSearch);var autoMethodHandler=function(ok,data){if(ok){_refresh_list=true;_close_when_done=false;_switchListView(data.subteam&&data.subteam.id?data.subteam.id:null)}};var auto_methods={owners:{create:function(){TS.api.call("subteams.createAuto",{type:"owner"},autoMethodHandler)},enable:function(){var user_group=_findAutoUserGroup("owner");if(!user_group)return;TS.user_groups.enableUserGroup(user_group.id,autoMethodHandler)}},admins:{create:function(){TS.api.call("subteams.createAuto",{type:"admin"},autoMethodHandler)},enable:function(){var user_group=_findAutoUserGroup("admin");if(!user_group)return;TS.user_groups.enableUserGroup(user_group.id,autoMethodHandler)}}};$("#user_group_alerts").off("click").on("click","a.user_group_auto_action",function(e){var $target=$(e.target);var type=$target.data("auto-type");var action=$target.data("auto-action");if(auto_methods[type]&&auto_methods[type][action]){auto_methods[type][action]();e.preventDefault();return false}})};var _switchToggleView=function(user_group,action){if(!user_group){TS.warn("Cannot switch toggle view to undefined user group");return}_$user_groups_toggle_div.html(TS.templates.user_group_toggle({action:action,user_group:user_group,show_delete:TS.boot_data.feature_subteams_hard_delete&&!user_group.auto_type&&!user_group.is_external}));_$user_groups_toggle_div.find('[data-action="cancel"]').on("click",_onReset);_$user_groups_toggle_div.find(".user_group_toggle_btn").on("click",function(e){var action=$(this).data("action");TS.user_groups[action](user_group.id,function(ok,data){if(_alertIfNotOk(ok,data))return;if(action==="enableUserGroup"){_enableUserGroup(user_group)}_onUpdateComplete()})});_$user_groups_toggle_div.find('[data-action="switch_delete_user_group"]').on("click",function(e){e.preventDefault();_switchToggleView(user_group,"delete_user_group")});_$all_user_groups.addClass("hidden");_$user_groups_toggle_div.removeClass("hidden");_bindBackButton()};var _enableUserGroup=function(user_group){var matching_groups=TS.model.user_groups.filter(function(group){return group.id===user_group.id});if(!matching_groups.length)TS.model.user_groups.push(TS.utility.clone(user_group))};var _switchSettingsFormView=function(user_group){_$user_groups_form_div.html(TS.templates.user_group_settings_form(user_group));var channels=TS.channels.getUnarchivedChannelsForUser().map(function(option){return{id:option.id,name:option.name}});var groups=TS.groups.getUnarchivedGroups().map(function(option){return{id:option.id,name:option.name,is_group:true}});var options=channels.concat(groups);if(user_group){var default_channels_groups=user_group.prefs.channels.concat(user_group.prefs.groups);default_channels_groups.forEach(function(item){for(var i=0;i<options.length;i++){if(item==options[i].id){options[i].selected=true;break}}})}$("#user_group_default_channels").filterSelect({data:options,template:function(item){if(item.is_group){return item.name}return"#"+item.name},placeholder_text:"Select the default channels for this user group (optional)",filter:function(item,query){var start_regex=new RegExp("^"+TS.utility.regexpEscape(query),"i");var prefix_regex=new RegExp("^"+TS.utility.regexpEscape(query.replace("#","")),"i");var suffix_regex=new RegExp("(-|_|\\+|\\s|\\.|#)"+TS.utility.regexpEscape(query),"i");return item.name.match(prefix_regex)||item.name.match(start_regex)||item.name.match(suffix_regex)}});_bindSettingsFormUI(user_group);_$all_user_groups.addClass("hidden");_$user_groups_form_div.removeClass("hidden");_bindBackButton()};var _bindSettingsFormUI=function(user_group){var save_function;var is_new;var user_group_id;if(user_group){save_function=TS.user_groups.updateUserGroup;is_new=false;user_group_id=user_group.id}else{save_function=TS.user_groups.createUserGroup;is_new=true}_$user_groups_form_div.find(".user_group_settings_form").on("submit",function(e){e.preventDefault();var name=$('input[name="name"]').val();var handle=$('input[name="handle"]').val();var description=$('input[name="description"]').val();var channels=$("#user_group_default_channels").filterSelect("value").map(function(channel){return channel.id});save_function({subteam:user_group_id,name:name,handle:handle,description:description,channels:channels},function(ok,data){if(_alertIfNotOk(ok,data))return;if(is_new){_temp_user_group=data.subteam;_switchMembersFormView(data.subteam,is_new)}else{_onUpdateComplete()}})});_$user_groups_form_div.find(".user_group_settings_form").on("reset",_onReset);var $button=$("#save_user_group");var $input=$("#user_group_name_input");function inputChange(){var value=$input.val();if(value&&value.length){$button.removeAttr("disabled")}else{$button.attr("disabled",true)}}if($button.length&&$input.length){$input.on("change",inputChange);$input.on("keyup",inputChange);inputChange()}};var _switchMembersFormView=function(user_group,is_new){var is_locked=!!user_group.is_external||!!user_group.auto_type;var options=TS.members.getMembersForUser().filter(_isFullMember).map(function(member){return{member:member}});var renderForm=function(){_$user_groups_form_div.html(TS.templates.user_group_members_form({is_new:is_new,is_locked:is_locked,user_group:user_group}))};var renderUI=function(){var $member_count=$("#member_count");var member_count=user_group.user_count||0;var updateForm=function(){var $button=$(is_new?"#create_group":"#save_group");if($button.length){if(member_count<1){$button.prop("disabled",true)}else{$button.prop("disabled",false)}}};$("#user_group_members_select").filterSelect({data:options,template:function(item){var html=TS.templates.user_group_invite_member_small(item);return new Handlebars.SafeString(html)},onItemAdded:function(item){member_count++;$member_count.html(member_count);updateForm()},onItemRemoved:function(item){member_count--;$member_count.html(member_count);updateForm()},filter:function(item,query){var member=item.member;if(query.charAt(0)==="@")query=query.substr(1);var start_regex=new RegExp("^"+TS.utility.regexpEscape(query),"i");var suffix_regex=new RegExp("(-|_|\\+|\\s|\\.|@)"+TS.utility.regexpEscape(query),"i");return TS.members.checkMemberMatch(member,start_regex)||TS.members.checkMemberMatch(member,suffix_regex)},disabled:!!user_group.is_external||!!user_group.auto_type});_bindMembersFormUI(user_group,is_new);_$all_user_groups.addClass("hidden");_$user_groups_form_div.removeClass("hidden");updateForm()};if(is_new){renderForm();TS.ui.fs_modal.hideBackButton();renderUI()}else{var selected_members;var work=function(){selected_members=user_group.users;selected_members.forEach(function(item){for(var i=0;i<options.length;i++){if(item==options[i].member.id){options[i].selected=true;break}}});renderForm();_bindBackButton();renderUI()};if(user_group.users===undefined){TS.user_groups.getUserGroupMembers(user_group.id,function(updated_group){if(updated_group&&updated_group.users){user_group=updated_group;return work()}})}else{return work()}}};var _bindMembersFormUI=function(user_group,is_new){_$user_groups_form_div.find(".user_group_members_form").on("submit",function(e){e.preventDefault();var members=$("#user_group_members_select").filterSelect("value").map(function(option){return option.member.id});TS.user_groups.updateMembersOfUserGroup({subteam:user_group.id,users:members},function(ok,data){if(_alertIfNotOk(ok,data))return;_temp_user_group=null;_onUpdateComplete()})});_$user_groups_form_div.find(".user_group_members_form").on("reset",function(e){e.preventDefault();if(is_new){if(TS.boot_data.feature_subteams_hard_delete){TS.user_groups.deleteUserGroup(user_group.id,function(ok,data){if(_alertIfNotOk(ok,data))return;_temp_user_group=null;_onReset(e)})}else{TS.user_groups.disableUserGroup(user_group.id,function(ok,data){if(_alertIfNotOk(ok,data))return;_temp_user_group=null;_onReset(e)})}}else{_onReset(e)}})};var _updateSearch=function(e){var $input=$(e.target);var value=$input.val();if(value!==_last_query){_last_query=value;_$icon_close.toggleClass("hidden",value==="");_refreshList()}};var _clearSearch=function(){var $input=$("#user_group_modal_search");_last_query="";$input.val("");setTimeout(function(){$input.focus()},0);_$icon_close.addClass("hidden");_refreshList()};var _refreshList=function(){var $list_div=$("#user_groups_list_div");var query=_last_query;var html;$("#user_groups_header .user_groups_search").toggleClass("hidden",!_user_groups.length);if(typeof query==="string"&&query.length){var user_groups=_user_groups.filter(function(ug){return ug.handle.indexOf(query)!==-1||ug._name_lc.indexOf(query)!==-1||ug.description&&ug.description.toLowerCase().indexOf(query)!==-1});if(user_groups.length){$list_div.html(TS.templates.builders.buildUserGroupListHTML(user_groups));if(_$monkey_scroll)_$monkey_scroll.updateFunc();return}var template_args={query:query,tab:{label:"user groups"}};html='<div class="no_results top_margin">'+TS.templates.team_list_no_results(template_args)+"</div>"}else{html=TS.templates.builders.buildUserGroupListHTML(_user_groups)}$list_div.html(html);if(_$monkey_scroll)_$monkey_scroll.updateFunc()};var _isFullMember=function(member){if(!member.deleted&&!member.is_ultra_restricted&&!member.is_restricted&&!(member.is_bot||member.is_slackbot)){return true}return false};var _getUserGroupFromId=function(id){if(id){for(var i=0;i<_user_groups.length;i++){if(_user_groups[i].id==id){return _user_groups[i]}}}return};var _last_query;var _$monkey_scroll;var _$icon_close})();
